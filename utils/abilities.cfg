#textdomain wesnoth-Era_of_Magic

#define WEAPON_SPECIAL_EOMA_ATTACK_ONLY
    [disable]
        id=eoma_attack_only
        name= _ "attack only"
        description= _ "This weapon will never be used on defense."
        active_on=defense
    [/disable]
#enddef

#define ABILITY_EOMA_KAMIKAZE
    [dummy]
        id=eoma_kamikaze
        name= _ "kamikaze"
        description=_"This unit always hits a target when attacking, but dies instantly afterwards."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]

[event]
    name=attack_end
    id=eoma_kamikaze_event
    first_time_only=no
    [filter]
        ability=eoma_kamikaze
        x,y=$x1,$y1
    [/filter]
    [kill]
        x,y=$x1,$y1
        animate=no
        fire_event=yes
    [/kill]
[/event]

[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_HITANDRUN VALUE
    [dummy]
        id=eoma_hitandrun{VALUE}
        name= _ "hit and run"+" "+"+"+{VALUE}
        description=_"This unit gains additional moves back after attacking, but cannot attack again."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=attack_end
    id=eoma_hitandrun_event{VALUE}
    first_time_only=no
    [filter]
        x,y=$x1,$y1
        ability=eoma_hitandrun{VALUE}
    [/filter]
    {VARIABLE_OP unit.moves add {VALUE}}
    [unstore_unit]
        variable=unit
        {COLOR_HEAL}
        text="+"+{VALUE}+" "+_"movepoints"
        find_vacant=no
    [/unstore_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_KILLANDRUN VALUE
    [dummy]
        id=eoma_killandrun{VALUE}
        name= _ "kill and run"+" "+"+"+{VALUE}
        description=_"This unit gains additional moves back after eliminating an opponent, but cannot attack again."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=eoma_killandrun_event{VALUE}
    first_time_only=no
    [filter]
    [/filter]
    [filter_second]
        x,y=$x2,$y2
        ability=eoma_killandrun{VALUE}
    [/filter_second]
    {VARIABLE_OP second_unit.moves add {VALUE}}
    [unstore_unit]
        variable=second_unit
        {COLOR_HEAL}
        text="+"+{VALUE}+" "+_"movepoints"
        find_vacant=no
    [/unstore_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define WEAPON_SPECIAL_EOMA_HITANDRUN VALUE
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
    [dummy]
        id=eoma_hitandrunspecial{VALUE}
        name= _ "hit and run"+" "+"+"+{VALUE}
        description=_"This unit gains additional moves back after attacking with this weapon, but cannot attack again."
    [/dummy]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
    name=attack_end
    id=eoma_hitandrunspecial_event{VALUE}
    first_time_only=no
    [filter_attack]
        special_id=eoma_hitandrunspecial{VALUE}
    [/filter_attack]
    {VARIABLE_OP unit.moves add {VALUE}}
    [unstore_unit]
        variable=unit
        {COLOR_HEAL}
        text="+"+{VALUE}+" "+_"movepoints"
        find_vacant=no
    [/unstore_unit]
[/event]
[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef

#define ABILITY_EOMA_FURY
    [dummy]
        id=eoma_fury
        name= _ "fury"
        description=_"This unit can attack another unit after killing an enemy."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=eoma_fury_event
    first_time_only=no
    [filter_second]
        side=$side_number
        ability=eoma_fury
    [/filter_second]

    {VARIABLE_OP second_unit.attacks_left add 1}
    [unstore_unit]
        variable=second_unit
        {COLOR_HARM}
        text= _ "FURY!"
        find_vacant=no
    [/unstore_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_FURIOUSDEATH DMG TYPE
    [damage]
        id=eoma_furiousdeath{DMG}{TYPE}
        name= _ "furious death"+" ({DMG})"
        description=_"Moments before this unit's death, it flies into a fury, dealing {DMG} impact damage to adjacent units, friend or foes alike. When a harmed adjacent unit goes to or below 0 HP, its HP are set to 1 instead of being killed."
    [/damage] # wmlxgettext: [abilities]
[/abilities]

[event]
    name=die
    id=eoma_furiousdeath_{DMG}{TYPE}
    first_time_only=no
    [filter]
        ability=eoma_furiousdeath{DMG}{TYPE}
    [/filter]

    {VARIABLE furydamage {DMG}}
    [if]
        {VARIABLE_CONDITIONAL unit.status.slowed boolean_equals yes}
        [then]
            {VARIABLE_OP furydamage divide 2}
            {VARIABLE_OP furydamage round floor}
        [/then]
    [/if]

    [harm_unit]
        [filter]
            [filter_adjacent]
                x,y=$x1,$y1
            [/filter_adjacent]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        amount=$furydamage
        alignment=$unit.alignment
        damage_type={TYPE}
        fire_event=yes
        kill=no
        animate=yes
        delay=0
        experience=no
    [/harm_unit]

    {CLEAR_VARIABLE furydamage}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_HARDLANDING DMG TYPE
    [dummy]
        id=eoma_hardlanding{DMG}{TYPE}
        name= _ "hard landing"+" ({DMG})"
        description=_"When this large unit is destroyed, it falls on a ground dealing damage to all adjacent units. When a harmed adjacent unit goes to or below 0 HP, its HP are set to 1 instead of being killed."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=eoma_hardlanding_event{DMG}{TYPE}
    first_time_only=no
    [filter]
        ability=eoma_hardlanding{DMG}{TYPE}
    [/filter]

    [harm_unit]
        [filter]
            [and]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
            [/and]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
            [not]
                find_in=parachutist
            [/not]
        [/filter]
        amount={DMG}
        damage_type={TYPE}
        fire_event=yes
        kill=no
        animate=yes
        delay=0
        experience=no
    [/harm_unit]
    {CLEAR_VARIABLE parachutist}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_PARACHUTE
    [dummy]
        id=eoma_parachute
        name= _ "parachute"
        description=_"The pilot of this machine is equipped with a parachute, and he can survive the destruction of his vehicle, continuing to fight as a lvl0 unit."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=eoma_parachute_event
    first_time_only=no
    [filter]
        ability=eoma_parachute
    [/filter]
    [item]
        x,y=$x1,$y1
        image=scenery/wreck-burning-eoma.png
        halo=scenery/flames[01~15].png~FL(horiz):50
    [/item]
    [unit]
        type=EoMa_Parachutist
        side=$unit.side
        x,y=$x1,$y1
        moves=0
        to_variable=parachutist
    [/unit]
    [unstore_unit]
        variable=parachutist
        find_vacant=yes
        animate=yes
    [/unstore_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define WEAPON_SPECIAL_EOMA_AREAEFFECT
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
    [damage]
        id=eoma_areaeffect
        name= _ "area effect"
        description=_"When this attack is used, all units adjacent to the target (except the attacker) receive half of the attack's damage. Does not work on defense."
    [/damage]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
    name=attacker_hits
    id=eoma_areaeffect_event
    first_time_only=no
    [filter_attack]
        special_id=eoma_areaeffect
    [/filter_attack]

    {VARIABLE halfdmg $weapon.damage}
    {VARIABLE_OP halfdmg divide 2}
    {VARIABLE_OP halfdmg round floor}

    [harm_unit]
        [filter]
            [filter_adjacent]
                x,y=$x2,$y2
            [/filter_adjacent]
            [not]
                x,y=$x1,$y1
            [/not]
            [filter_side]
                [enemy_of]
                    side=$unit.side
                [/enemy_of]
            [/filter_side]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        [filter_second]
            x,y=$x1,$y1
        [/filter_second]
        amount=$halfdmg
        damage_type=$weapon.type
        alignment=$unit.alignment
        fire_event=yes
        animate=defender
        delay=0
        experience=no
    [/harm_unit]
    [harm_unit]
        [filter]
            [filter_adjacent]
                x,y=$x2,$y2
            [/filter_adjacent]
            [not]
                x,y=$x1,$y1
            [/not]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
            [filter_side]
                [allied_with]
                    side=$unit.side
                [/allied_with]
                [or]
                    side=$unit.side
                [/or]
            [/filter_side]
        [/filter]
        [filter_second]
            x,y=$x1,$y1
        [/filter_second]
        amount=$halfdmg
        damage_type=$weapon.type
        alignment=$unit.alignment
        fire_event=yes
        animate=defender
        kill=no
        delay=0
        experience=no
    [/harm_unit]
    [if]
        [have_unit]
            find_in=expfreeze
            [filter_adjacent]
                x,y=$x2,$y2
            [/filter_adjacent]
            [not]
                x,y=$x1,$y1
            [/not]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/have_unit]
        [else]
            [store_unit]
                [filter]
                    [filter_adjacent]
                        x,y=$x2,$y2
                    [/filter_adjacent]
                    [not]
                        x,y=$x1,$y1
                    [/not]
                    [not]
                        [filter_wml]
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                variable=expfreeze
                mode=append
            [/store_unit]
        [/else]
    [/if]
    {CLEAR_VARIABLE halfdmg}
[/event]

{EXPFREEZE_EVENT}
[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef

#----------------------------------------------------
#define WEAPON_SPECIAL_EOMA_AREAEFFECTRANDOM CHANCETOHIT
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
    [damage]
        id=eoma_areaeffectrandom
        name= _ "random area effect"
        description=_"When this attack is used, random units adjacent to the target (except the attacker) get half of the basic damage. Does not work on defense."
    [/damage]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
    name=attacker_hits,attacker_misses
    id=eoma_areaeffect_event
    first_time_only=no
    [filter_attack]
        special_id=eoma_areaeffectrandom
    [/filter_attack]

    {VARIABLE halfdmg $weapon.damage}
    {VARIABLE_OP halfdmg divide 2}
    {VARIABLE_OP halfdmg round floor}

    [store_unit]
        [filter]
            [filter_adjacent]
                x,y=$x2,$y2
            [/filter_adjacent]
            [not]
                x,y=$x1,$y1
            [/not]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable=bystander
    [/store_unit]

    [foreach]
        array=bystander
        [do]
            {RANDOM 1..100}
            [if]
                {VARIABLE_CONDITIONAL random less_than_equal_to {CHANCETOHIT}}
                [then]
                    [harm_unit]
                        [filter]
                            x,y=$this_item.x,$this_item.y
                            [filter_side]
                                [enemy_of]
                                    side=$unit.side
                                [/enemy_of]
                            [/filter_side]
                            [not]
                                [filter_wml]
                                    [status]
                                        petrified=yes
                                    [/status]
                                [/filter_wml]
                            [/not]
                        [/filter]
                        [filter_second]
                            x,y=$x1,$y1
                        [/filter_second]
                        amount=$halfdmg
                        damage_type=$weapon.type
                        alignment=$unit.alignment
                        fire_event=yes
                        animate=defender
                        delay=0
                        experience=no
                    [/harm_unit]
                    [harm_unit]
                        [filter]
                            x,y=$this_item.x,$this_item.y
                            [filter_side]
                                [allied_with]
                                    side=$unit.side
                                [/allied_with]
                                [or]
                                    side=$unit.side
                                [/or]
                            [/filter_side]
                            [not]
                                [filter_wml]
                                    [status]
                                        petrified=yes
                                    [/status]
                                [/filter_wml]
                            [/not]
                        [/filter]
                        [filter_second]
                            x,y=$x1,$y1
                        [/filter_second]
                        amount=$halfdmg
                        damage_type=$weapon.type
                        alignment=$unit.alignment
                        fire_event=yes
                        animate=defender
                        kill=no
                        delay=0
                        experience=no
                    [/harm_unit]
                    [if]
                        [have_unit]
                            find_in=expfreeze
                            x,y=$this_item.x,$this_item.y
                        [/have_unit]
                        [else]
                            [store_unit]
                                [filter]
                                    x,y=$this_item.x,$this_item.y
                                [/filter]
                                variable=expfreeze
                                mode=append
                            [/store_unit]
                        [/else]
                    [/if]
                [/then]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE halfdmg}
[/event]

{EXPFREEZE_EVENT}
[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef
#----------------------------------------------------

#define WEAPON_SPECIAL_EOMA_SWALLOW VALUE
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
    [damage]
        id=eoma_swallow{VALUE}
        name= _ "swallow"+" +"+"{VALUE}"
        description=_"When killing a living enemy, this unit is healed by "+{VALUE}+" "+{EOMA_NO_RPG}
    [/damage]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
    name=die
    id=eoma_swallow_event{VALUE}
    first_time_only=no
    [filter_condition]
#ifdef MULTIPLAYER
        [EoMa_not_rpg]
        [/EoMa_not_rpg]
#endif
    [/filter_condition]
    [filter]
        [not]
            [filter_wml]
                [status]
                    not_living="yes"
                [/status]
            [/filter_wml]
        [/not]
    [/filter]

    [filter_second_attack]
        special_id=eoma_swallow{VALUE}
    [/filter_second_attack]

    [heal_unit]
        [filter]
            x,y=$x2,$y2
        [/filter]
        amount={VALUE}
        animate=yes
    [/heal_unit]
[/event]

[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef

#define WEAPON_SPECIAL_EOMA_COLLECTOR VALUE
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
    [damage]
        id=eoma_collector{VALUE}
        name= _ "collector"+" +"+"{VALUE}"
        description=_"This unit gains {VALUE} HP added to its current health whenever it kills a non-magical unit. It also gains +1 max HP with each successful kill of a non-magical unit. This special works only on offense."+" "+{EOMA_NO_RPG}
        active_on=offense
    [/damage]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
    name=die
    id=eoma_collector_event{VALUE}
    first_time_only=no
    [filter_condition]
#ifdef MULTIPLAYER
        [EoMa_not_rpg]
        [/EoMa_not_rpg]
#endif
    [/filter_condition]
    [filter]
        [not]
            race=eoma_magical
        [/not]
    [/filter]

    [filter_second_attack]
        special_id_active=eoma_collector{VALUE}
    [/filter_second_attack]

    #increase max hp
    {VARIABLE maxhp $second_unit.max_hitpoints}
    {VARIABLE_OP maxhp add 1}
    {MODIFY_UNIT id=$second_unit.id max_hitpoints $maxhp}
    [floating_text]
        x,y=$x2,$y2
        text="<span color='#00ff00'>"+_"+1 max hp"+"</span>"
    [/floating_text]
    [delay]
        time=400
    [/delay]
    {CLEAR_VARIABLE maxhp}

    [heal_unit]
        [filter]
            x,y=$x2,$y2
        [/filter]
        amount={VALUE}
        animate=yes
    [/heal_unit]
[/event]

[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef

#define ABILITY_EOMA_SPLIT TYPE
    [dummy]
        id=eoma_split
        name= _ "split"
        description=_"When dying this unit splits into 2 smaller versions of itself."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=eoma_split
    first_time_only=no
    [filter]
        ability=eoma_split
    [/filter]
    [unit]
        type={TYPE}
        side=$unit.side
        x,y=$x1,$y1
        moves=0
        animate=no
    [/unit]
    [unit]
        type={TYPE}
        side=$unit.side
        x,y=$x1,$y1
        moves=0
        animate=no
    [/unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define WEAPON_SPECIAL_EOMA_ANTISHIELD
    [dummy]
        id=eoma_antishield
        name= _ "anti-shield"
        description=_"This attack negates all possible resistances, thus the damage output is always constant."
    [/dummy]
#enddef

#define ABILITY_EOMA_POISONOUS_AURA
    [dummy]
        id=eoma_poisonousaura
        name= _ "poisonous aura"
        description=_"All living non-magical enemy units adjacent to this unit lose 2 HP and become poisoned at the beginning of this unit's turn. If an enemy unit's HP goes to or below 0 HP, its HP are set to 1."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=turn refresh
    id=eoma_poisonousaura
    first_time_only=no

    [store_unit]
        [filter]
            type=EoMa_Chosen_of_Marsh
            side=$side_number
        [/filter]
        variable=com
    [/store_unit]

    [foreach]
        array=com
        [do]
            [animate_unit]
                flag=poisonaura
                [filter]
                    id=$this_item.id
                [/filter]
            [/animate_unit]

            [harm_unit]
                [filter]
                    [filter_adjacent]
                        id=$this_item.id
                        is_enemy=yes
                    [/filter_adjacent]
                    [not]
                        [filter_wml]
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                    [not]
                        race=mechanical
                        [or]
                            race=eoma_magical
                        [/or]
                        [or]
                            race=undead
                        [/or]
                    [/not]
                [/filter]
                amount=2
                fire_event=yes
                animate=no
                kill=no
                poisoned=yes
            [/harm_unit]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE com}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_ALTER_EGO
    [dummy]
        id=eoma_alterego
        name= _ "alter ego"
        description=_"At night this unit transforms into its alternative version."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=turn refresh
    id=eoma_alterego
    first_time_only=no

    {TRANSFORM_UNIT (
        type=EoMa_Atokpi_Master
        [filter_location]
            time_of_day_id=first_watch,second_watch,underground,deep_underground
        [/filter_location]
    ) EoMa_Atokpi_Dark}

    {TRANSFORM_UNIT (
        type=EoMa_Atokpi_Dark
        [filter_location]
            time_of_day_id=dawn,dusk,morning,afternoon
        [/filter_location]
    ) EoMa_Atokpi_Master}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_DAMAGEAURA VALUE TYPE ALIGNMENT
    [dummy]
        id=eoma_damageaura{VALUE}
        name= _ "damage aura"+" ({VALUE})"
        description=_"This unit harms all adjacent enemies at the start of each turn by a certain amount of damage (affected by the ToD bonus), giving the unit experience for each enemy harmed/killed."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=side turn
    id={TYPE}_damageaura
    first_time_only=no

    [store_unit]
        [filter]
            type={TYPE}
            side=$side_number
        [/filter]
        variable={TYPE}
    [/store_unit]

    [foreach]
        array={TYPE}
        [do]
            [harm_unit]
                [filter]
                    [filter_adjacent]
                        x,y=$this_item.x,$this_item.y
                    [/filter_adjacent]
                    [not]
                        side=$side_number|
                        [or]
                            [filter_side]
                                [allied_with]
                                    side=$side_number
                                [/allied_with]
                            [/filter_side]
                        [/or]
                    [/not]
                    [not]
                        [filter_wml]
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                [filter_second]
                    id=$this_item.id
                [/filter_second]
                [primary_attack]
                    name=aura
                [/primary_attack]
                amount={VALUE}
                alignment={ALIGNMENT}
                damage_type=secret
                experience=yes
                fire_event=yes
                animate=yes
            [/harm_unit]
            [store_unit]
                [filter]
                    [filter_adjacent]
                        x,y=$this_item.x,$this_item.y
                    [/filter_adjacent]
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                    [not]
                        [filter_wml]
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                variable=expsub
            [/store_unit]
            {IF_VAR expsub.length greater_than 0 (
                [then]
                    {VARIABLE_OP expsub.experience sub $this_item.level}
                    [unstore_unit]
                        variable=expsub
                        find_vacant=no
                    [/unstore_unit]
                [/then]
            )}
        [/do]
    [/foreach]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_ZOMBIE_DAMAGEAURA VALUE VARIATION
    [dummy]
        id=lesser_eoma_damageaura{VALUE}
        name= _ "lesser damage aura"+" "+{VALUE}
        description=_"This unit harms all adjacent enemies at the start of each turn by a certain amount of damage (affected by the ToD bonus), without giving the unit experience for each enemy harmed. Like poison, it can't kill."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=side turn
    id={VARIATION}_damageaura_lesser
    first_time_only=no

    [store_unit]
        [filter]
            side=$side_number
            ability=lesser_eoma_damageaura{VALUE}
        [/filter]
        variable={VARIATION}
    [/store_unit]

    [foreach]
        array={VARIATION}
        [do]
            [harm_unit]
                [filter]
                    [filter_adjacent]
                        x,y=$this_item.x,$this_item.y
                    [/filter_adjacent]
                    [not]
                        side=$side_number|
                        [or]
                            [filter_side]
                                [allied_with]
                                    side=$side_number
                                [/allied_with]
                            [/filter_side]
                        [/or]
                    [/not]
                    [not]
                        [filter_wml]
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                [filter_second]
                    id=$this_item.id
                [/filter_second]
                [primary_attack]
                    name=aura
                [/primary_attack]
                amount={VALUE}
                alignment=chaotic
                damage_type=secret
                experience=no
                fire_event=yes
                kill=no
                animate=yes
            [/harm_unit]
        [/do]
    [/foreach]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define IMMOBILIZE_MOVE_COST VALUE
    [effect]
        apply_to=movement_costs
        replace=no
        [movement_costs]
            deep_water={VALUE}
            shallow_water={VALUE}
            swamp_water={VALUE}
            reef={VALUE}
            flat={VALUE}
            sand={VALUE}
            forest={VALUE}
            hills={VALUE}
            mountains={VALUE}
            village={VALUE}
            castle={VALUE}
            cave={VALUE}
            frozen={VALUE}
            unwalkable={VALUE}
            fungus={VALUE}
        [/movement_costs]
    [/effect]
#enddef

#define WEAPON_SPECIAL_EOMA_IMMOBILIZE
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
    [damage]
        id=eoma_immoblize
        name= _ "immobilize"
        description=_"When used offensively, units hit with this attack become unable to move for 1 turn"
    [/damage]
[/specials]
# wmlindent: start ignoring
[/attack]
[event]
    name=attacker hits
    id=eoma_immobilize_event
    first_time_only=no
    [filter_second]
      [filter_wml]
        [not]
      [status]
         immobilized=yes
      [/status]
    [/not]
      [/filter_wml]
    [/filter_second]
    [filter_attack]
        special_id=eoma_immoblize
    [/filter_attack]

    # Record information about the immobilization
    [set_variables]
        name=immobilize_unit_information
        mode=append
        [value]
            id=$second_unit.id
            side=$second_unit.side
            turn_of_mobilizing=$"($turn_number| + 1)"
        [/value]
    [/set_variables]
    {MODIFY_UNIT id=$second_unit.id status.immobilized yes}
        [object]
            silent=yes
            [filter]
                find_in=second_unit
            [/filter]
            {IMMOBILIZE_MOVE_COST 99}
        [/object]
[/event]
[event]
    name=side turn
    id=eoma_immobilize_event2
    first_time_only=no

    [foreach]
        array=immobilize_unit_information
        [do]
            [if]
                [variable]
                    name=this_item.turn_of_mobilizing
                    less_than_equal_to=$turn_number
                [/variable]
                [and]
                    [variable]
                        name=this_item.side
                        equals=$side_number
                    [/variable]
                [/and]

                [then]
                    [object]
                        silent=yes
                        [filter]
                            find_in=this_item
                        [/filter]
                        {IMMOBILIZE_MOVE_COST -99}
                    [/object]
                    
                    {MODIFY_UNIT id=$this_item.id status.immobilized no}

                    [clear_variable]
                        name=this_item
                    [/clear_variable]
                [/then]
            [/if]
        [/do]
    [/foreach]
[/event]

[event]
    name=victory
    id=eoma_immobilize_event3
    first_time_only=no
    
    [foreach]
        array=immobilize_unit_information
        [do]
            [object]
                silent=yes
                [filter]
                    find_in=this_item
                [/filter]
                {IMMOBILIZE_MOVE_COST -99}
            [/object]
            
           {MODIFY_UNIT id=$this_item.side.id status.immobilized no}

            [clear_variable]
                name=this_item
            [/clear_variable]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE immobilize_unit_information}
[/event]
[+attack]
[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
#enddef

#define DAZZLE_DEFENSE VALUE
                    [effect]
                        apply_to=defense
            replace=no
              [defense]
            deep_water={VALUE}
                shallow_water={VALUE}
                swamp_water={VALUE}
                reef={VALUE}
                flat={VALUE}
                sand={VALUE}
                forest={VALUE}
                hills={VALUE}
                mountains={VALUE}
                village={VALUE}
                castle={VALUE}
                cave={VALUE}
                frozen={VALUE}
                unwalkable={VALUE}
                fungus={VALUE}
              [/defense]
                    [/effect]
#enddef

#define WEAPON_SPECIAL_EOMA_DAZZLE
# wmlxgettext: [attack]
# wmlxgettext: [specials]

[damage]
    id=eoma_dazzle
    name= _ "dazzle"
    description=_"When used offensively, units hit with this attack suffer a 35% reduction in damage and a 10% reduction in defenses for 1 turn"
[/damage]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
    name=attacker hits
    id=eoma_dazzle_event
    first_time_only=no
    [filter_second]
        [not]
            ability=dazzled
        [/not]
    [/filter_second]
    [filter_attack]
        special_id=eoma_dazzle
    [/filter_attack]

    # Record information about the dazzling
    [set_variables]
        name=dazzle_unit_information
        mode=append
        [value]
            id=$second_unit.id
            side=$second_unit.side
            turn_of_undazzle=$"($turn_number| + 1)"
        [/value]
    [/set_variables]
    {MODIFY_UNIT id=$second_unit.id status.dazzled yes}
    [object]
        silent=yes
        [filter]
            find_in=second_unit
        [/filter]
        {DAZZLE_DEFENSE 10}
        [effect]
            apply_to=new_ability
            [abilities]
                [leadership]
                    id=dazzled
                    value=-30
                    cumulative=no
                    affect_self=yes
                [/leadership]
            [/abilities]
        [/effect]
    [/object]
[/event]
[event]
    name=side turn
    id=eoma_dazzle_event2
    first_time_only=no

    [foreach]
        array=dazzle_unit_information
        [do]
            [if]
                [variable]
                    name=this_item.turn_of_mobilizing
                    less_than_equal_to=$turn_number
                [/variable]
                [and]
                    [variable]
                        name=this_item.side
                        equals=$side_number
                    [/variable]
                [/and]

                [then]
                    [object]
                        silent=yes
                        [filter]
                            find_in=this_item
                        [/filter]
                        {DAZZLE_DEFENSE -10}
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                [leadership]
                                    id=dazzled
                                    value=-30
                                    cumulative=no
                                    affect_self=yes
                                [/leadership]
                            [/abilities]
                        [/effect]
                    [/object]
                    {MODIFY_UNIT id=$this_item.id status.dazzled no}

                    [clear_variable]
                        name=this_item
                    [/clear_variable]
                [/then]
            [/if]
        [/do]
    [/foreach]
[/event]

[event]
    name=victory
    id=eoma_dazzle_event3
    first_time_only=no

    [foreach]
        array=dazzle_unit_information
        [do]
            [object]
                silent=yes
                [filter]
                    find_in=this_item
                [/filter]
                {DAZZLE_DEFENSE -99}
                [effect]
                    apply_to=remove_ability
                    [abilities]
                        [leadership]
                            id=dazzled
                            value=-30
                            cumulative=no
                            affect_self=yes
                        [/leadership]
                    [/abilities]
                [/effect]
            [/object]
            {MODIFY_UNIT id=$this_item.side.id status.dazzled no}

            [clear_variable]
                name=this_item
            [/clear_variable]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE dazzle_unit_information}
[/event]
[+attack]
    [+specials]
        # wmlxgettext: [/specials]
        # wmlxgettext: [/attack]
#enddef

#taken from EFM
#define WEAPON_SPECIAL_EOMA_STUN
    [chance_to_hit]
        id=eoma_stun
        name= _ "stun"
        description= _ "This attack puts enormous pressure on the enemy, disrupting his ZOC if a hit is landed. Not active on defense. Does not work on units that do not have a ZoC."
        apply_to=opponent
        active_on=offense
        value=60
        cumulative=yes
    [/chance_to_hit]
    # wmlxgettext: [specials]
[/specials]
# wmlxgettext: [attack]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring

[event]
    name=attacker_hits
    first_time_only=no
    [filter_attack]
        special_id=eoma_stun
    [/filter_attack]
    [filter_second]
        [not]
            [filter_wml]
                zoc=no
            [/filter_wml]
        [/not]
    [/filter_second]

    [if]
        [variable]
            name=second_unit.variables.stunned
            boolean_equals=no
        [/variable]
        [then]
            {VARIABLE second_unit.variables.stunned yes}

            [unstore_unit]
                variable=second_unit
                find_vacant=no
                text=_ "stunned"
                red,green,blue=196,196,128
            [/unstore_unit]

            [object]
                silent=yes
                duration=scenario

                [filter]
                    x,y=$x2,$y2
                [/filter]

                [effect]
                    apply_to=image_mod
                    replace="CS(50,50,0)"
                [/effect]

                [effect]
                    apply_to=zoc
                    value=no
                [/effect]
            [/object]
        [/then]
    [/if]
[/event]

[event]
    name=turn refresh
    first_time_only=no

    [store_unit]
        [filter]
            side=$side_number
            [filter_wml]
                [variables]
                    stunned=yes
                [/variables]
            [/filter_wml]
        [/filter]
        variable=stunned
    [/store_unit]

    [foreach]
        array=stunned
        [do]
            {VARIABLE this_item.variables.stunned no}

            [unstore_unit]
                variable=this_item
            [/unstore_unit]

            [object]
                silent=yes
                duration=scenario

                [filter]
                    x,y=$this_item.x,$this_item.y
                [/filter]

                [effect]
                    apply_to=image_mod
                    replace="NOP()"
                [/effect]

                [effect]
                    apply_to=zoc
                    value=yes
                [/effect]
            [/object]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE stunned}
[/event]

[+attack]
    # wmlxgettext: [/attack]
    [+specials]
        # wmlxgettext: [/specials]

#enddef

#define ABILITY_EOMA_BLOODLUST VALUE
    [dummy]
        id=eoma_bloodlust{VALUE}
        name= _ "bloodlust"+" +"+"{VALUE}"
        description=_"This unit gains {VALUE} hitpoints added to its current health whenever it kills a living unit. This ability works only on offense."
        active_on=offense
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=attack end
    id=eoma_bloodlust_event
    first_time_only=no

    [filter]
        ability=eoma_bloodlust{VALUE}
    [/filter]
    [filter_second]
        [not]
            race=undead
            [or]
                race=mechanical
            [/or]
            [or]
                race=eoma_magical
            [/or]
        [/not]
    [/filter_second]

    {VARIABLE eoma_bloodlust_active yes}
[/event]
[event]
    name=die
    id=eoma_bloodlust_event2
    first_time_only=no

    [filter]
        [not]
            race=undead
            [or]
                race=mechanical
            [/or]
            [or]
                race=eoma_magical
            [/or]
        [/not]
    [/filter]
    [filter_second]
        ability=eoma_bloodlust{VALUE}
    [/filter_second]

    {IF_VAR eoma_bloodlust_active equals yes (
        [then]
            [delay]
                time=100
            [/delay]
            [heal_unit]
                [filter]
                    id=$second_unit.id
                [/filter]
                amount={VALUE}
                animate=yes
                restore_statuses=no
            [/heal_unit]
            {CLEAR_VARIABLE eoma_bloodlust_active}
        [/then]
    )}
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define WEAPON_SPECIAL_EOMA_SUPERCHARGE
# wmlindent: start ignoring
# wmlxgettext: [attack]
# wmlxgettext: [specials]

# wmlindent: stop ignoring
    [damage]
        id=eoma_supercharge
        name= _ "supercharge"
        description= _ "When used offensively, this attack deals 150% damage to the target. It also causes this unit to take 150% damage from the target’s counterattack.

When the opponent is defeated, the attacker with this ability moves to the opponent's location."
        multiply=1.5
        apply_to=both
        active_on=offense
    [/damage]
[/specials]
# wmlindent: start ignoring
[/attack]
# wmlindent: stop ignoring
[event]
    name=die
    id=eoma_supercharge_event
    first_time_only=no

    [filter_second_attack]
        special_id=eoma_supercharge
    [/filter_second_attack]

    [kill]
        find_in=unit
        animate=no
        fire_event=yes
    [/kill]

    {MOVE_UNIT id=$second_unit.id $unit.x $unit.y}

    [switch]
        variable=unit.level
        [case]
            value=0
            {VARIABLE exp_fix 4}
            {VARIABLE_OP exp_fix add $second_unit.experience}
            {MODIFY_UNIT find_in=second_unit experience $exp_fix}
        [/case]
        [else]
            {VARIABLE exp_fix 8}
            {VARIABLE_OP exp_fix multiply $unit.level}
            {VARIABLE_OP exp_fix add $second_unit.experience}
            {MODIFY_UNIT find_in=second_unit experience $exp_fix}
        [/else]
    [/switch]
[/event]

[+attack]
# wmlindent: start ignoring

[+specials]
# wmlxgettext: [/specials]
# wmlxgettext: [/attack]
# wmlindent: stop ignoring
#enddef

#define ABILITY_EOMA_SCAVENGER VALUE
    [dummy]
        id=eoma_scavenger{VALUE}
        name= _ "scavenger"+" +"+"{VALUE}"
        description=_"This unit gains {VALUE} hitpoints added to its current health whenever an adjacent unit dies."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=eoma_scavenger_event
    first_time_only=no

    [filter]
        [filter_adjacent]
            ability=eoma_scavenger{VALUE}
        [/filter_adjacent]
    [/filter]

    [delay]
        time=100
    [/delay]
    [heal_unit]
        [filter]
            ability=eoma_scavenger{VALUE}
            [filter_adjacent]
                id=$unit.id
            [/filter_adjacent]
        [/filter]
        amount={VALUE}
        animate=yes
    [/heal_unit]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define WEAPON_SPECIAL_EOMA_DREAD
    [damage]
        id=eoma_dread
        name= _ "dread"
        name_inactive= _ "dread"
        description=_"When this attack is used offensively, this unit takes one third less damage in retaliation."
        description_inactive=_"When this attack is used offensively, this unit takes one third less damage in retaliation."
        active_on=offense
        apply_to=opponent
        multiply=0.66
    [/damage]
#enddef

#define WEAPON_SPECIAL_EOMA_EVADE
    [damage]
        id=eoma_evade
        name= _ "evade"
        name_inactive= _ "evade"
        description=_"When this attack is used offensively, this unit takes 25% less damage in retaliation."
        description_inactive=_"When this attack is used offensively, this unit takes 25% less damage in retaliation."
        active_on=offense
        apply_to=opponent
        multiply=0.75
    [/damage]
#enddef

#define WEAPON_SPECIAL_EOMA_MAGIC_HARDENING
    [damage]
        id=eoma_magic_hardening
        multiply=0.8
        name= _ "magic hardening"
        description= _ "While attacking, this unit will take 20% less fire/cold/arcane damage in retaliation."
        affect_self=no
        apply_to=opponent
        active_on=offense
        [filter_opponent]
            [filter_weapon]
                type=fire,cold,arcane
            [/filter_weapon]
        [/filter_opponent]
    [/damage]
#enddef

#define ABILITY_EOMA_CHAOS_CHANNELLING
    [dummy]
        id=eoma_chaos_channeling
        name= _ "chaos channelling"
        description=_"When this unit dies a new Chaotic Observer unit is placed on the recall list of this unit's side."
    [/dummy] # wmlxgettext: [abilities]
[/abilities]
[event]
    name=die
    id=chaos_channelling_event
    first_time_only=no

    [filter]
        type=EoMa_Dark_Portal,EoMa_Infernal_Vortex,EoMa_Black_Portal
    [/filter]

    [unit]
        side=$unit.side
        type=EoMa_Chaotic_Observer
        placement=recall
    [/unit]

    [floating_text]
        x,y=$unit.x,$unit.y
        text="<span color='red'>" + _ "Recalling..." + "</span>"
    [/floating_text]
[/event]
[+abilities] # wmlxgettext: [/abilities]
#enddef

#define ABILITY_EOMA_ILLUMINATES_WEAK
    [illuminates]
        id=eoma_illuminates_weak
        value=15
        max_value=25
        cumulative=no
        name= _ "illuminates (weak)"
        description= _ "This unit illuminates the surrounding area, making lawful units fight better, and chaotic units fight worse.

Unlike the 'illuminates' ability, this ability affects the damage bonus/penalty for adjacent units by 15%, instead of 25%."
        affect_self=yes
    [/illuminates]
#enddef

#define WEAPON_SPECIAL_EOMA_ANTIMECH VALUE
    [damage]
        id=eoma_antimech{VALUE}
        name= _ "anti-mech"+" +"+{VALUE}
        description=_"This attacks deals additional {VALUE} points of damage against mechanical units."
        apply_to=self
        add={VALUE}
        [filter_opponent]
            race=mechanical
        [/filter_opponent]
    [/damage]
#enddef
